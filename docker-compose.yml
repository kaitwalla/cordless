services:
  web:
    build:
      context: .
      args:
        - BUNDLE_WITHOUT=
    ports:
      - "3000:80"
    environment:
      - SECRET_KEY_BASE=${SECRET_KEY_BASE:?SECRET_KEY_BASE must be set in .env or environment}
      - REDIS_URL=redis://redis:6379/0
      - RAILS_ENV=${RAILS_ENV:-development}
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY:-}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY:-}
      - DISABLE_SSL=true
      - BUNDLE_WITHOUT=
      - STORAGE_SERVICE=${STORAGE_SERVICE:-local}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-}
      - AWS_S3_ENDPOINT=${AWS_S3_ENDPOINT:-}
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      # Note: LIVEKIT_URL must be accessible from the browser, so use localhost (not the Docker service name)
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://localhost:7880}
      - SELENIUM_URL=http://chrome:4444/wd/hub
    volumes:
      - .:/rails
      - /rails/vendor/bundle  # Don't mount over installed gems
      - ${STORAGE_PATH:-./data/storage}:/rails/storage
    depends_on:
      redis:
        condition: service_healthy
      livekit:
        condition: service_healthy
      chrome:
        condition: service_healthy
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    volumes:
      - ${REDIS_DATA_PATH:-./data/redis}:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  livekit:
    image: livekit/livekit-server:latest
    command: --dev
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7880/"]
      interval: 10s
      timeout: 5s
      retries: 3

  chrome:
    image: seleniarm/standalone-chromium:latest
    shm_size: 2gb
    ports:
      # Bound to localhost only - noVNC has default password "secret"
      - "127.0.0.1:4444:4444"
      - "127.0.0.1:7900:7900"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 10s
      timeout: 5s
      retries: 3

# Storage paths are configurable via environment variables:
# - STORAGE_PATH: Rails storage (default: ./data/storage)
# - REDIS_DATA_PATH: Redis persistence (default: ./data/redis)
